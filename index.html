<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中学体力テスト記録システム</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>📊 体力テスト 2025</h1>
    
    <div class="card no-print" style="text-align:center">
        <button class="btn btn-clear" onclick="clearData()">🗑️ クリア</button>
<button class="btn btn-print" onclick="window.print()">🖨️ 印刷</button>
<button class="btn btn-save" onclick="saveYearData()">📅 今年を記録</button>
<button class="btn btn-send" onclick="sendToTeacher()">📤 先生に送信</button>
<button class="btn btn-setup" onclick="checkPasscode()">⚙️ 初回設定</button>
    </div>
    
    <div class="card no-print" style="text-align:center">
        性別：<select id="gender" onchange="RR(this.value)" style="...">
    <option value="男">男子</option>
    <option value="女">女子</option>
</select>
        学年：<select id="grade" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="1">中1</option>
            <option value="2" selected>中2</option>
            <option value="3">中3</option>
        </select>
        組：<select id="class" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="A">A組</option>
            <option value="B">B組</option>
            <option value="C">C組</option>
            <option value="D">D組</option>
        </select>
        測定回：<select id="session" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="1">1回目</option>
            <option value="2">2回目</option>
            <option value="3">3回目</option>
        </select>
    </div>
    
    <div class="card">
        <h2 style="color:#2b6cb0;margin-top:0">📈 マイレコード</h2>
        <div id="table"></div>
    </div>
    
    <div class="card no-print" style="text-align:center">
        <button class="btn" style="background:linear-gradient(135deg,#2c5282,#2b6cb0)" onclick="toggleRadar()">📊 レーダーチャート</button>
        <button class="btn" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)" onclick="toggleAnalysis()">🎮 体力分析</button>
        <button class="btn" style="background:linear-gradient(135deg,#FF5722,#FF7043)" onclick="toggleTracking()">📈 種目別トラッキング</button>
    </div>
    
    <div id="radar" style="display:none" class="card">
        <h3 style="text-align:center;color:#2b6cb0;margin-bottom:20px">📊 レーダーチャート</h3>
        <div style="display:flex;justify-content:center">
            <canvas id="rc" width="600" height="600"></canvas>
        </div>
    </div>
    
    <div id="correlation" style="display:none" class="card">
        <h3 style="text-align:center;color:#9c27b0;margin-bottom:30px">🎮 体力レーダー図鑑 × 目標達成シミュレーター</h3>
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:30px;border-radius:15px;margin-bottom:30px;color:white">
            <h4 style="margin:0 0 25px 0;font-size:24px;text-align:center">🏆 あなたの体力タイプ図鑑</h4>
            <div id="fitnessPokedex" style="display:grid;grid-template-columns:1fr 1fr;gap:20px"></div>
            <div id="totalRank" style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.2);border-radius:12px;text-align:center;font-size:20px;font-weight:bold"></div>
        </div>
        <div style="background:#f5f5f5;padding:30px;border-radius:15px">
            <h4 style="margin:0 0 20px 0;font-size:22px;text-align:center;color:#9c27b0">🎯 目標達成シミュレーター</h4>
            <div style="text-align:center;margin-bottom:25px">
                <button class="btn" style="background:linear-gradient(135deg,#FFD700,#FFA500)" onclick="setGoal('rankA')">総合A評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#66BB6A)" onclick="setGoal('rankB')">総合B評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#2196F3,#42A5F5)" onclick="setGoal('rankC')">総合C評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#9C27B0,#BA68C8)" onclick="setGoal('rankD')">総合D評価を目指す</button>
            </div>
            <div id="goalSimulator"></div>
        </div>
    </div>
    
    <div id="tracking" style="display:none" class="card">
        <h3 style="text-align:center;color:#FF5722;margin-bottom:30px">📈 種目別トラッキング</h3>
        <div style="background:linear-gradient(135deg,#FF5722,#FF7043);padding:30px;border-radius:15px;margin-bottom:30px;color:white">
            <h4 style="margin:0 0 25px 0;font-size:22px;text-align:center">📝 新しい記録を追加</h4>
            <div style="background:rgba(255,255,255,0.15);padding:25px;border-radius:12px;backdrop-filter:blur(10px)">
    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin-bottom:20px">
        <div>
            <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">学年</label>
            <select id="trackingViewGrade" onchange="updateTrackingView()" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px;background:white">
                <option value="1">中1</option>
                <option value="2" selected>中2</option>
                <option value="3">中3</option>
            </select>
        </div>
        <div>
            <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">種目</label>
            <select id="trackingEvent" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px;background:white">
                <option value="0">握力</option>
                <option value="1">上体起こし</option>
                <option value="2">長座体前屈</option>
                <option value="3">反復横とび</option>
                <option value="4">持久走</option>
                <option value="5">20mシャトルラン</option>
                <option value="6">50m走</option>
                <option value="7">立ち幅跳び</option>
                <option value="8">ハンドボール投げ</option>
            </select>
        </div>
        <div>
            <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">測定値</label>
            <input type="number" id="trackingValue" step="0.01" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px;font-weight:bold" placeholder="数値入力">
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:15px; margin-bottom:20px">
        <div>
            <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">単元名（任意）</label>
            <input type="text" id="trackingUnit" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px" placeholder="例: バスケットボール">
        </div>
        <div>
            <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">日付</label>
            <input type="date" id="trackingDate" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px">
        </div>
    </div>

    <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:bold;font-size:12px">メモ（任意）</label>
        <input type="text" id="trackingMemo" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px" placeholder="メモを入力">
    </div>
    <div style="text-align:center">
        <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#66BB6A);font-size:16px;padding:12px 40px" onclick="addTrackingRecord()">➕ 記録を追加</button>
    </div>
</div>
        </div>
        <div style="background:#f5f5f5;padding:30px;border-radius:15px;margin-bottom:30px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h4 style="margin:0;font-size:20px;color:#FF5722">📊 変容グラフ</h4>
                <div>
                    <label style="margin-right:10px;color:#666">表示種目:</label>
                    <select id="trackingViewEvent" onchange="updateTrackingView()" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0">
                        <option value="0">握力</option>
                        <option value="1">上体起こし</option>
                        <option value="2">長座体前屈</option>
                        <option value="3">反復横とび</option>
                        <option value="4">持久走</option>
                        <option value="5">20mシャトルラン</option>
                        <option value="6">50m走</option>
                        <option value="7">立ち幅跳び</option>
                        <option value="8">ハンドボール投げ</option>
                    </select>

                </div>
            </div>
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px">
                <canvas id="trackingGraph" width="1000" height="400"></canvas>
            </div>
            <div id="trackingStats" style="background:white;padding:20px;border-radius:12px"></div>
        </div>
        <div style="background:#f5f5f5;padding:30px;border-radius:15px">
            <h4 style="margin:0 0 20px 0;font-size:20px;color:#FF5722">📝 記録一覧</h4>
            <div id="trackingList" style="background:white;border-radius:12px;overflow:hidden"></div>
        </div>
    </div>
    
    <div class="card no-print">
        <h2 style="color:#2b6cb0">⭐ 点数基準</h2>
        <div id="score"></div>
    </div>
    
    <div class="card no-print">
        <h2 style="color:#2b6cb0">🏆 総合ランク</h2>
        <div id="eval"></div>
    </div>
    
    <div id="notif" class="notification"></div>
    
    <div id="setupModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;overflow-y:auto">
        <div style="max-width:900px;margin:50px auto;background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
            <div style="text-align:right;margin-bottom:20px">
                <button onclick="closeSetupGuide()" style="background:none;border:none;font-size:30px;cursor:pointer;color:#666">✕</button>
            </div>
            <div id="setupContent">
                <h2 style="color: #2b6cb0; text-align: center;">🏫 初期設定ガイド</h2>
                
                <div style="background: #f0f7ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #2b6cb0;">
                    <p><strong>1. 専用プログラムのコピー</strong></p>
                    <p style="font-size: 13px; color: #555;">集計用のプログラムをコピーします（この後の手順で使用します）。</p>
                    <button onclick="copyGsCode()" style="width:100%; padding:12px; background:#2b6cb0; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">📋 プログラムをコピーする</button>
                    
                    <textarea id="gsCodeSource" style="display:none;">
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // シート名を作成
    var sheetName = data.grade + "年-" + data.class + "組-" + data.session + "回目";
    var sheet = ss.getSheetByName(sheetName);
    
    // シートがなければ新規作成
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      sheet.appendRow(['出席番号', '氏名', '性別', '学年', '組', '回', '握力', '上体', '長座', '反復', '持久', 'シャトル', '50m', '立ち幅', '投', '日時']);
    }

    // --- 上書き処理の追加 ---
    var rows = sheet.getDataRange().getValues();
    var rowIndex = -1;
    
    // 2行目から順番に見て、出席番号(0列目)と氏名(1列目)が一致する行があるか探す
    for (var i = 1; i < rows.length; i++) {
      if (rows[i][0] == data.studentId && rows[i][1] == data.name) {
        rowIndex = i + 1; // 一致する行が見つかった
        break;
      }
    }

    // 書き込むデータ
    var rowData = [
      data.studentId || "",
      data.name || "",
      data.gender === 'male' ? '男子' : '女子',
      data.grade || "",
      data.class || "",
      data.session || "",
      data.grip || "",
      data.situp || "",
      data.forward || "",
      data.sidestep || "",
      data.endurance || "",
      data.shuttle || "",
      data.sprint50 || "",
      data.jump || "",
      data.throw || "",
      new Date()
    ];

    if (rowIndex > 0) {
      // 既存の行がある場合は「上書き」
      sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
    } else {
      // 新規の場合は「最後尾に追加」
      sheet.appendRow(rowData);
    }

    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);

  } catch (f) {
    return ContentService.createTextOutput("Error: " + f.toString()).setMimeType(ContentService.MimeType.TEXT);
  }
}
                    </textarea>
                </div>

               <div style="background: #fdfaea; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #f6ad55;">
    <p><strong>2. Googleスプレッドシートの設定</strong></p>
    <ol style="font-size: 13px; color: #333; line-height: 1.8; padding-left: 20px;">
        <li><a href="https://sheets.new/" target="_blank" style="color: #2b6cb0; font-weight: bold; text-decoration: underline;">ここをクリックして新しいスプレッドシートを作成</a>します。</li>
        <li>上のメニューから<b>「拡張機能」→「Apps Script」</b>をクリック。</li>
        <li>開いた画面にあるコードをすべて消して、先ほどコピーしたプログラムを<b>貼り付け</b>ます。</li>
        <li>右上の青いボタン<b>「デプロイ」→「新しいデプロイ」</b>をクリック。</li>
        <li>種類の選択（歯車アイコン）から<b>「ウェブアプリ」</b>を選びます。</li>
        <li>以下の設定であることを確認して「デプロイ」を押します。
            <ul style="margin-top:5px; color: #e53e3e; font-weight: bold; list-style: none; padding-left: 10px;">
                <li>● 次のユーザーとして実行：自分</li>
                <li>● アクセスできるユーザー：全員</li>
            </ul>
        </li>
    </ol>

    <div style="margin-top: 10px; padding: 10px; background: #fff; border: 1px dashed #f6ad55; border-radius: 8px; font-size: 12px;">
        <p style="font-weight: bold; color: #d69e2e; margin-bottom: 5px;">⚠️ 初回デプロイ時に「承認」を求められたら：</p>
        <p>1. 「アクセスを承認」を押し、自分のアカウントを選択します。</p>
        <p>2. <b>「このアプリは Google で確認されていません」</b>と出たら、左下の<b style="color:#2b6cb0; text-decoration:underline;">「詳細（Advanced）」</b>をクリック。</p>
        <p>3. 一番下の<b style="color:#2b6cb0; text-decoration:underline;">「（プロジェクト名）に移動（安全ではない）」</b>をクリック。</p>
        <p>4. 最後に「許可」を押せば完了です。</p>
    </div>
    
    <p style="font-size: 13px; margin-top: 10px;">最後に表示される<b>「ウェブアプリURL」</b>をコピーして、この画面に戻ってください。</p>
</div>

    <div style="background: #fff5f0; padding: 15px; border-radius: 10px; border: 2px solid #FF5722;">
    <p><strong>3. URLの登録と生徒への配布</strong></p>
    <p style="font-size: 13px; margin-bottom: 10px;">コピーした「ウェブアプリURL」を貼り付けて保存してください。</p>
    
    <input type="text" id="gasUrlInput" autocomplete="off" placeholder="https://script.google.com/macros/s/..." style="width:100%; padding:10px; margin-bottom:10px; border: 1px solid #ccc; border-radius: 5px;" value="">
    
    <button onclick="saveGasUrl()" style="width:100%; padding:12px; background:#FF5722; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">💾 設定を保存して配布URLを作る</button>
    
    <div id="studentUrlArea" style="display:none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #FF5722;">
        <p style="font-size: 13px; font-weight: bold; color: #2d3748;">✅ 準備完了！生徒に配るURL：</p>
        <input type="text" id="studentDistUrlInput" autocomplete="off" readonly style="width:100%; padding:10px; font-size:11px; background: #eee; border: 1px solid #ccc; margin-bottom: 10px;" value="">
        <button onclick="copyStudentUrl()" style="width:100%; padding:10px; background:#4CAF50; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">📋 URLをコピーして生徒に配布</button>
    </div>
</div>
            </div>
        </div>
    </div>
    
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/setup.js"></script>

    <script>
    // 1. パスコードをチェックする関数
    function checkPasscode() {
        const code = prompt("管理者用パスコードを入力してください（4桁）");
        if (code === "9076") {
            showSetupGuide();
        } else if (code !== null) {
            alert("パスコードが違います。");
        }
    }

    // 2. 設定画面を表示する関数
    function showSetupGuide() {
        const gasInput = document.getElementById('gasUrlInput');
        const distInput = document.getElementById('studentDistUrlInput');
        const urlArea = document.getElementById('studentUrlArea');
        if (gasInput) gasInput.value = ""; 
        if (distInput) distInput.value = "";
        if (urlArea) urlArea.style.display = "none";
        document.getElementById('setupModal').style.display = "block";
    }

    // 3. ページ読み込み時の初期化
    window.onload = function() {
        // 学年・性別の変更時に表を更新するようにイベントを追加
        document.getElementById("gender").addEventListener("change", function() {
            if (typeof renderTable === 'function') renderTable();
            if (typeof RR === 'function') RR(this.value);
        });
        
        document.getElementById("grade").addEventListener("change", function() {
            if (typeof renderTable === 'function') renderTable();
            const g = document.getElementById("gender").value;
            if (typeof RR === 'function') RR(g);
        });

        // 初回実行
        const gender = document.getElementById("gender").value;
        if (typeof renderTable === 'function') renderTable(); 
        if (typeof RR === 'function') RR(gender);
    };
    </script> </body>
</html>

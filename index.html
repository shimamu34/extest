<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中学体力テスト記録システム</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>📊 体力テスト 2025</h1>
    
    <!-- コントロールボタン -->
    <div class="card no-print" style="text-align:center">
        <button class="btn" style="background:linear-gradient(135deg,#2196F3,#1976D2)" onclick="exportData()">💾 バックアップ</button>
        <button class="btn" style="background:linear-gradient(135deg,#2196F3,#1976D2)" onclick="importData()">📂 復元</button>
        <button class="btn" style="background:linear-gradient(135deg,#ff9800,#f57c00)" onclick="clearAllData()">🗑️ クリア</button>
        <button class="btn" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)" onclick="window.print()">🖨️ 印刷</button>
        <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#388E3C)" onclick="saveYearData()">📅 今年を記録</button>
        <button class="btn" style="background:linear-gradient(135deg,#e91e63,#c2185b)" onclick="sendToTeacher()">📤 先生に送信</button>
        <button class="btn" style="background:linear-gradient(135deg,#FF5722,#FF7043)" onclick="showSetupGuide()">⚙️ 初回設定</button>
    </div>
    
    <!-- 基本情報選択 -->
    <div class="card no-print" style="text-align:center">
        性別：<select id="gender" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="male">男子</option>
            <option value="female">女子</option>
        </select>
        学年：<select id="grade" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="1">中1</option>
            <option value="2" selected>中2</option>
            <option value="3">中3</option>
        </select>
        組：<select id="class" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="A">A組</option>
            <option value="B">B組</option>
            <option value="C">C組</option>
            <option value="D">D組</option>
        </select>
        測定回：<select id="session" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;margin:0 10px">
            <option value="1">1回目</option>
            <option value="2">2回目</option>
            <option value="3">3回目</option>
        </select>
    </div>
    
    <!-- マイレコードテーブル -->
    <div class="card">
        <h2 style="color:#2b6cb0;margin-top:0">📈 マイレコード</h2>
        <div id="table"></div>
    </div>
    
    <!-- グラフ表示ボタン -->
    <div class="card no-print" style="text-align:center">
        <button class="btn" style="background:linear-gradient(135deg,#2c5282,#2b6cb0)" onclick="toggleRadar()">📊 レーダーチャート</button>
        <button class="btn" style="background:linear-gradient(135deg,#2c5282,#2b6cb0)" onclick="toggleGrowth()">📈 経年変化</button>
        <button class="btn" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)" onclick="toggleAnalysis()">🎮 体力分析</button>
        <button class="btn" style="background:linear-gradient(135deg,#FF5722,#FF7043)" onclick="toggleTracking()">📈 種目別トラッキング</button>
    </div>
    
    <!-- レーダーチャート -->
    <div id="radar" style="display:none" class="card">
        <h3 style="text-align:center;color:#2b6cb0;margin-bottom:20px">📊 レーダーチャート</h3>
        <div style="display:flex;justify-content:center">
            <canvas id="rc" width="600" height="600"></canvas>
        </div>
    </div>
    
    <!-- 経年変化グラフ -->
    <div id="growth" style="display:none" class="card">
        <h3 style="text-align:center;color:#2b6cb0;margin-bottom:20px">📈 経年変化グラフ</h3>
        <canvas id="gc" width="1000" height="500"></canvas>
    </div>
    
    <!-- 体力分析 -->
    <div id="correlation" style="display:none" class="card">
        <h3 style="text-align:center;color:#9c27b0;margin-bottom:30px">🎮 体力レーダー図鑑 × 目標達成シミュレーター</h3>
        
        <!-- 体力図鑑 -->
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:30px;border-radius:15px;margin-bottom:30px;color:white">
            <h4 style="margin:0 0 25px 0;font-size:24px;text-align:center">🏆 あなたの体力タイプ図鑑</h4>
            <div id="fitnessPokedex" style="display:grid;grid-template-columns:1fr 1fr;gap:20px"></div>
            <div id="totalRank" style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.2);border-radius:12px;text-align:center;font-size:20px;font-weight:bold"></div>
        </div>
        
        <!-- 目標達成シミュレーター -->
        <div style="background:#f5f5f5;padding:30px;border-radius:15px">
            <h4 style="margin:0 0 20px 0;font-size:22px;text-align:center;color:#9c27b0">🎯 目標達成シミュレーター</h4>
            <div style="text-align:center;margin-bottom:25px">
                <button class="btn" style="background:linear-gradient(135deg,#FFD700,#FFA500)" onclick="setGoal('rankA')">総合A評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#66BB6A)" onclick="setGoal('rankB')">総合B評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#2196F3,#42A5F5)" onclick="setGoal('rankC')">総合C評価を目指す</button>
                <button class="btn" style="background:linear-gradient(135deg,#9C27B0,#BA68C8)" onclick="setGoal('rankD')">総合D評価を目指す</button>
            </div>
            <div id="goalSimulator"></div>
        </div>
    </div>
    
    <!-- 種目別トラッキング -->
    <div id="tracking" style="display:none" class="card">
        <h3 style="text-align:center;color:#FF5722;margin-bottom:30px">📈 種目別トラッキング</h3>
        
        <!-- 記録入力エリア -->
        <div style="background:linear-gradient(135deg,#FF5722,#FF7043);padding:30px;border-radius:15px;margin-bottom:30px;color:white">
            <h4 style="margin:0 0 25px 0;font-size:22px;text-align:center">📝 新しい記録を追加</h4>
            <div style="background:rgba(255,255,255,0.15);padding:25px;border-radius:12px;backdrop-filter:blur(10px)">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold">種目</label>
                        <select id="trackingEvent" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px">
                            <option value="0">握力</option>
                            <option value="1">上体起こし</option>
                            <option value="2">長座体前屈</option>
                            <option value="3">反復横とび</option>
                            <option value="4">持久走</option>
                            <option value="5">20mシャトルラン</option>
                            <option value="6">50m走</option>
                            <option value="7">立ち幅跳び</option>
                            <option value="8">ハンドボール投げ</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold">測定値</label>
                        <input type="number" id="trackingValue" step="0.01" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px" placeholder="例: 48">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold">単元名（任意）</label>
                        <input type="text" id="trackingUnit" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px" placeholder="例: バスケットボール">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold">日付</label>
                        <input type="date" id="trackingDate" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px">
                    </div>
                </div>
                <div style="margin-bottom:20px">
                    <label style="display:block;margin-bottom:8px;font-weight:bold">メモ（任意）</label>
                    <input type="text" id="trackingMemo" style="width:100%;padding:10px;border-radius:8px;border:none;font-size:14px" placeholder="例: ドリブル練習多め">
                </div>
                <div style="text-align:center">
                    <button class="btn" style="background:linear-gradient(135deg,#4CAF50,#66BB6A);font-size:16px;padding:12px 40px" onclick="addTrackingRecord()">➕ 記録を追加</button>
                </div>
            </div>
        </div>
        
        <!-- グラフ表示エリア -->
        <div style="background:#f5f5f5;padding:30px;border-radius:15px;margin-bottom:30px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h4 style="margin:0;font-size:20px;color:#FF5722">📊 変容グラフ</h4>
                <div>
                    <label style="margin-right:10px;color:#666">表示種目:</label>
                    <select id="trackingViewEvent" onchange="updateTrackingView()" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0">
                        <option value="0">握力</option>
                        <option value="1">上体起こし</option>
                        <option value="2">長座体前屈</option>
                        <option value="3">反復横とび</option>
                        <option value="4">持久走</option>
                        <option value="5">20mシャトルラン</option>
                        <option value="6">50m走</option>
                        <option value="7">立ち幅跳び</option>
                        <option value="8">ハンドボール投げ</option>
                    </select>
                </div>
            </div>
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px">
                <canvas id="trackingGraph" width="1000" height="400"></canvas>
            </div>
            <div id="trackingStats" style="background:white;padding:20px;border-radius:12px"></div>
        </div>
        
        <!-- 記録一覧 -->
        <div style="background:#f5f5f5;padding:30px;border-radius:15px">
            <h4 style="margin:0 0 20px 0;font-size:20px;color:#FF5722">📝 記録一覧</h4>
            <div id="trackingList" style="background:white;border-radius:12px;overflow:hidden"></div>
        </div>
    </div>
    
    <!-- 点数基準 -->
    <div class="card no-print">
        <h2 style="color:#2b6cb0">⭐ 点数基準</h2>
        <div id="score"></div>
    </div>
    
    <!-- 総合ランク -->
    <div class="card no-print">
        <h2 style="color:#2b6cb0">🏆 総合ランク</h2>
        <div id="eval"></div>
    </div>
    
    <!-- 通知 -->
    <div id="notif" class="notification"></div>
    
    <!-- 初回設定ガイドモーダル -->
    <div id="setupModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;overflow-y:auto">
        <div style="max-width:900px;margin:50px auto;background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
            <div style="text-align:right;margin-bottom:20px">
                <button onclick="closeSetupGuide()" style="background:none;border:none;font-size:30px;cursor:pointer;color:#666">✕</button>
            </div>
            <div id="setupContent">
    <h2 style="color: #2b6cb0; text-align: center; margin-bottom: 25px;">🏫 先生向け送信設定ガイド</h2>
    
    <p style="margin-bottom: 20px; font-size: 14px; color: #666;">※この設定は、データを集計する「管理者（先生）」のみが行ってください。</p>

    <div style="background: #f0f7ff; padding: 20px; border-radius: 12px; border-left: 6px solid #2b6cb0; margin-bottom: 20px;">
        <p style="font-weight: bold; color: #2b6cb0; margin-bottom: 10px;">Step 1: スクリプトをコピーする</p>
        <p style="font-size: 14px; margin-bottom: 10px;">下のボタンを押して、スプレッドシートに貼り付けるプログラムをコピーしてください。</p>
        <button onclick="copyGsCode()" style="background: #2b6cb0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">📋 スクリプトをコピー</button>
        <textarea id="gsCodeSource" style="display:none;">
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('体力テスト記録');
    if (!sheet) {
      sheet = ss.insertSheet('体力テスト記録');
      sheet.appendRow(['出席番号', '氏名', '性別', '学年', '組', '測定回', '握力', '上体起こし', '長座体前屈', '反復横とび', '持久走', 'シャトルラン', '50m走', '立ち幅跳び', 'ハンドボール投げ', 'タイムスタンプ']);
    }
    sheet.appendRow([data.studentId, data.name, data.gender, data.grade, data.class, data.session, data.grip, data.situp, data.forward, data.sidestep, data.endurance, data.shuttle, data.sprint50, data.jump, data.throw, new Date()]);
    return ContentService.createTextOutput(JSON.stringify({result: 'success'})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({result: 'error', message: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
        </textarea>
    </div>

    <div style="background: #f2faf0; padding: 20px; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 20px;">
        <p style="font-weight: bold; color: #388e3c; margin-bottom: 10px;">Step 2: Googleスプレッドシートに設置</p>
        <ol style="margin-left: 20px; font-size: 14px; line-height: 1.6;">
            <li>スプレッドシートの「拡張機能」→「Apps Script」を開きます。</li>
            <li>先ほどコピーしたコードを貼り付けて保存します。</li>
            <li>右上の<strong>「デプロイ」</strong>→<strong>「新しいデプロイ」</strong>をクリック。</li>
            <li>種類を<strong>「ウェブアプリ」</strong>にし、アクセス権を<strong>「全員」</strong>に設定して公開します。</li>
        </ol>
    </div>

    

    <div style="background: #fff5f0; padding: 25px; border-radius: 12px; border: 2px solid #FF5722; text-align: center;">
        <p style="font-weight: bold; color: #FF5722; margin-bottom: 15px;">Step 3: ウェブアプリURLを貼り付け</p>
        <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/..." 
               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
        <button class="btn" style="background: #FF5722; width: 100%; color:white" onclick="saveGasUrl()">設定を保存してはじめる</button>
    </div>
</div>
    <div style="background: #f2faf0; padding: 20px; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 20px;">
        <p style="font-weight: bold; font-size: 18px; color: #388e3c; margin-bottom: 10px;">Step 2: Webアプリとして公開（重要！）</p>
        <ol style="margin-left: 20px; line-height: 1.8;">
            <li>右上の<strong>「デプロイ」</strong>→<strong>「新しいデプロイ」</strong>を選択。</li>
            <li>種類の選択（歯車アイコン）から<strong>「ウェブアプリ」</strong>を選びます。</li>
            <li>設定を以下のように変更してください：
                <ul style="margin-top: 5px; background: white; padding: 10px; border-radius: 8px; list-style: none; border: 1px dashed #4CAF50;">
                    <li>✅ 次のユーザーとして実行：<strong>自分</strong></li>
                    <li>✅ アクセスできるユーザー：<strong>全員</strong>（※ここを間違えると送信できません）</li>
                </ul>
            </li>
            <li>「デプロイ」を押し、表示された<strong>「ウェブアプリURL」</strong>をコピーします。</li>
        </ol>
    </div>

    <div style="background: #fff5f0; padding: 25px; border-radius: 12px; border: 2px solid #FF5722; text-align: center;">
        <p style="font-weight: bold; font-size: 18px; color: #FF5722; margin-bottom: 15px;">Step 3: URLの登録</p>
        <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/..." 
               style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 16px;">
        <button class="btn" style="background: linear-gradient(135deg,#FF5722,#FF7043); width: 100%; padding: 15px; font-size: 18px;" 
                onclick="saveGasUrl()">設定を保存してはじめる</button>
    </div>
</div>
        </div>
    </div>
    
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/setup.js"></script>
</body>
</html>
